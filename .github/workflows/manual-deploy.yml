name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'production'
      
      deploy_backend:
        description: 'Deploy backend'
        required: false
        type: boolean
        default: true
      
      deploy_frontend:
        description: 'Deploy frontend'
        required: false
        type: boolean
        default: true
      
      skip_backup:
        description: 'Skip backup'
        required: false
        type: boolean
        default: false
      
      restart_passenger:
        description: 'Restart Passenger after deploy (MyDevil.net)'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20.x'

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_backend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        working-directory: ./proxeon-srv
        run: npm ci --production

      - name: Prepare backend artifact
        working-directory: ./proxeon-srv
        run: |
          # Copy create-admin.sh script to backend directory
          cp ../create-admin.sh ./create-admin.sh
          chmod +x ./create-admin.sh

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            proxeon-srv/
            !proxeon-srv/node_modules
            !proxeon-srv/.env
            !proxeon-srv/backend.log
            !proxeon-srv/logs.txt
          retention-days: 7

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_frontend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install frontend dependencies
        working-directory: ./proxeon-client
        run: npm install

      - name: Build frontend
        working-directory: ./proxeon-client
        run: |
          # Set environment-specific variables
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "REACT_APP_SERVER_URL=https://meet.sqx.pl" > .env.production
          else
            echo "REACT_APP_SERVER_URL=https://4meet.sqx.pl" > .env.production
          fi
          echo "REACT_APP_DOMAIN=proxeon" >> .env.production
          
          # Build (CI=false to allow ESLint warnings)
          CI=false npm run build
          
      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: proxeon-client/build/
          retention-days: 7

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend artifact
        if: ${{ inputs.deploy_backend }}
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./deploy/backend

      - name: Download frontend artifact
        if: ${{ inputs.deploy_frontend }}
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./deploy/frontend

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo '‚úÖ SSH connection successful'"

      - name: Create backup on server
        if: ${{ !inputs.skip_backup }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/proxeon_manual_$TIMESTAMP"
            
            echo "üì¶ Creating backup: $BACKUP_DIR"
            mkdir -p "$BACKUP_DIR"
            
            if [ "${{ inputs.deploy_backend }}" = "true" ]; then
              if [ "${{ inputs.environment }}" = "production" ] && [ -d "${{ secrets.DEPLOY_PATH_BACKEND }}" ]; then
                echo "Backing up backend..."
                rsync -a --exclude='node_modules' --exclude='.env' \
                  "${{ secrets.DEPLOY_PATH_BACKEND }}/" "$BACKUP_DIR/backend/"
              elif [ "${{ inputs.environment }}" = "staging" ] && [ -d "${{ secrets.DEPLOY_PATH_BACKEND_DEV }}" ]; then
                echo "Backing up backend..."
                rsync -a --exclude='node_modules' --exclude='.env' \
                  "${{ secrets.DEPLOY_PATH_BACKEND_DEV }}/" "$BACKUP_DIR/backend/"
              fi
            fi
            
            # Backup frontend (from static directory)
            if [ "${{ inputs.deploy_frontend }}" = "true" ]; then
              if [ "${{ inputs.environment }}" = "production" ] && [ -d "${{ secrets.DEPLOY_PATH_BACKEND }}/static" ]; then
                echo "Backing up frontend..."
                rsync -a "${{ secrets.DEPLOY_PATH_BACKEND }}/static/" "$BACKUP_DIR/frontend/"
              elif [ "${{ inputs.environment }}" = "staging" ] && [ -d "${{ secrets.DEPLOY_PATH_BACKEND_DEV }}/static" ]; then
                echo "Backing up frontend..."
                rsync -a "${{ secrets.DEPLOY_PATH_BACKEND_DEV }}/static/" "$BACKUP_DIR/frontend/"
              fi
            fi
            
            echo "‚úÖ Backup completed: $BACKUP_DIR"
          EOF

      - name: Deploy backend
        if: ${{ inputs.deploy_backend }}
        run: |
          echo "üöÄ Deploying backend..."
          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND }}"
          else
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND_DEV }}"
          fi
          
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='backend.log' \
            --exclude='logs.txt' \
            --exclude='.git' \
            ./deploy/backend/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$DEPLOY_PATH/
          
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            cd $DEPLOY_PATH
            echo "üì¶ Installing backend dependencies..."
            npm ci --production
            mkdir -p public/logos
            mkdir -p static
            echo "‚úÖ Backend deployed"
          EOF

      - name: Deploy frontend
        if: ${{ inputs.deploy_frontend }}
        run: |
          echo "üöÄ Deploying frontend..."
          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND }}/static"
          else
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND_DEV }}/static"
          fi
          
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./deploy/frontend/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$DEPLOY_PATH/
          echo "‚úÖ Frontend deployed to $DEPLOY_PATH"

      - name: Restart Passenger
        if: ${{ inputs.deploy_backend && inputs.restart_passenger }}
        run: |
          echo "üîÑ Restarting Passenger (MyDevil.net)..."
          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND }}"
          else
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND_DEV }}"
          fi
          
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            cd $DEPLOY_PATH
            
            # Create tmp directory if it doesn't exist
            mkdir -p tmp
            
            # Restart Passenger by touching restart.txt
            touch tmp/restart.txt
            
            echo "‚úÖ Passenger restart triggered (tmp/restart.txt updated)"
            echo "‚ÑπÔ∏è  Application will restart on next HTTP request"
          EOF

      - name: Health check
        if: ${{ inputs.deploy_backend }}
        run: |
          echo "‚è≥ Waiting 15 seconds for Passenger to start application..."
          sleep 15
          
          # Health check - try to reach the /health endpoint
          if [ "${{ inputs.environment }}" = "production" ]; then
            HEALTH_URL="https://meet.sqx.pl/health"
            DOMAIN="meet.sqx.pl"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND }}"
          else
            HEALTH_URL="https://4meet.sqx.pl/health"
            DOMAIN="4meet.sqx.pl"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_BACKEND_DEV }}"
          fi
          
          echo "üè• Checking health at: $HEALTH_URL"
          
          # First, test DNS resolution
          echo "üîç Testing DNS resolution..."
          if ! nslookup $DOMAIN > /dev/null 2>&1; then
            echo "‚ö†Ô∏è DNS resolution failed for $DOMAIN"
          else
            echo "‚úÖ DNS resolution OK"
          fi
          
          # Test connection with verbose output
          echo "üîç Testing connection..."
          curl -v -s -o /tmp/health_response.txt -w "\nHTTP_CODE:%{http_code}\nTIME_TOTAL:%{time_total}\n" "$HEALTH_URL" 2>&1 | head -20 || true
          
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /tmp/health_response.txt -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed! (HTTP $HTTP_CODE)"
              if [ -f /tmp/health_response.txt ]; then
                cat /tmp/health_response.txt
              fi
              rm -f /tmp/health_response.txt
              exit 0
            else
              echo "‚ùå Attempt $i/5 failed (HTTP $HTTP_CODE)"
              if [ "$HTTP_CODE" = "000" ]; then
                echo "   ‚ö†Ô∏è Connection failed - server may not be reachable"
                echo "   üí° Possible causes:"
                echo "      - Domain not configured in MyDevil.net panel"
                echo "      - Node.js application not set up in DevilWEB"
                echo "      - SSL certificate not configured"
                echo "      - Firewall blocking connection"
              fi
              if [ -f /tmp/health_response.txt ] && [ -s /tmp/health_response.txt ]; then
                echo "   Response:"
                head -5 /tmp/health_response.txt
                echo ""
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "‚è≥ Waiting 5 seconds before retry..."
              sleep 5
            fi
          done
          
          echo ""
          echo "‚ö†Ô∏è Health check failed after 5 attempts"
          echo ""
          echo "üí° Troubleshooting steps:"
          echo "   1. Verify domain is configured in MyDevil.net DevilWEB panel:"
          echo "      - Go to: https://panelX.mydevil.net"
          echo "      - Strony WWW ‚Üí Check if '$DOMAIN' exists"
          echo "      - Type: Node.js"
          echo "      - Port: [PORT]"
          echo ""
          echo "   2. Check if Passenger restarted:"
          echo "      ssh user@s1.mydevil.net"
          echo "      cd $DEPLOY_PATH"
          echo "      ls -la tmp/restart.txt"
          echo ""
          echo "   3. Check application logs in DevilWEB panel"
          echo ""
          echo "   4. Verify .env file:"
          echo "      cat $DEPLOY_PATH/.env | grep -E 'MONGO_URI|PORT'"
          echo ""
          echo "   5. Test manually from server:"
          echo "      curl http://localhost:[PORT]/health"
          echo ""
          echo "‚ö†Ô∏è Deployment completed, but health check failed. Please investigate manually."
          rm -f /tmp/health_response.txt
          exit 0

      - name: Deployment summary
        if: success()
        run: |
          echo "================================================"
          echo "‚úÖ MANUAL DEPLOYMENT COMPLETED"
          echo "================================================"
          echo "Environment: ${{ inputs.environment }}"
          echo "Backend deployed: ${{ inputs.deploy_backend }}"
          echo "Frontend deployed: ${{ inputs.deploy_frontend }}"
          echo "Passenger restarted: ${{ inputs.restart_passenger }}"
          echo "Backup created: ${{ !inputs.skip_backup }}"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Time: $(date)"
          echo "================================================"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf ./deploy

